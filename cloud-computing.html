<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Unofficial NWFSC and SWFSC Groundfish Stock Assessment Handbook - 6&nbsp; Cloud computing: jittering a stock assessment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./appendix-a.html" rel="next">
<link href="./05-other.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./cloud-computing.html"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Cloud computing: jittering a stock assessment</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Unofficial NWFSC and SWFSC Groundfish Stock Assessment Handbook</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/pfmc-assessments/pfmc_assessment_handbook" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-data-sources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Data sources: notes, contact information, and links</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-model-choices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Modeling choices, notes and best practices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-stock-synthesis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Running Stock Synthesis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-post-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">So you ran an assessment model, more notes and best practices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Other useful tidbits</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cloud-computing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Cloud computing: jittering a stock assessment</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix-a.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Species seen* in the hake fishery</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix-b.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Alaska Center CRUISEJOINS for shelf and slope surveys</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#pick-a-vm" id="toc-pick-a-vm" class="nav-link active" data-scroll-target="#pick-a-vm"><span class="header-section-number">6.1</span> Pick a VM</a></li>
  <li><a href="#connect-to-your-vm" id="toc-connect-to-your-vm" class="nav-link" data-scroll-target="#connect-to-your-vm"><span class="header-section-number">6.2</span> Connect to your VM</a></li>
  <li><a href="#install-software" id="toc-install-software" class="nav-link" data-scroll-target="#install-software"><span class="header-section-number">6.3</span> Install software</a></li>
  <li><a href="#connect-to-rstudio" id="toc-connect-to-rstudio" class="nav-link" data-scroll-target="#connect-to-rstudio"><span class="header-section-number">6.4</span> Connect to Rstudio</a>
  <ul class="collapse">
  <li><a href="#a-note-on-rstudio" id="toc-a-note-on-rstudio" class="nav-link" data-scroll-target="#a-note-on-rstudio"><span class="header-section-number">6.4.1</span> A note on Rstudio</a></li>
  </ul></li>
  <li><a href="#install-packages" id="toc-install-packages" class="nav-link" data-scroll-target="#install-packages"><span class="header-section-number">6.5</span> Install packages</a></li>
  <li><a href="#move-files" id="toc-move-files" class="nav-link" data-scroll-target="#move-files"><span class="header-section-number">6.6</span> Move files</a>
  <ul class="collapse">
  <li><a href="#other-file-transfer-methods-that-you-might-consider" id="toc-other-file-transfer-methods-that-you-might-consider" class="nav-link" data-scroll-target="#other-file-transfer-methods-that-you-might-consider"><span class="header-section-number">6.6.1</span> Other file transfer methods that you might consider</a></li>
  </ul></li>
  <li><a href="#make-sure-you-log-off-your-vm" id="toc-make-sure-you-log-off-your-vm" class="nav-link" data-scroll-target="#make-sure-you-log-off-your-vm"><span class="header-section-number">6.7</span> Make sure you log off your VM!!!</a></li>
  <li><a href="#some-thoughts" id="toc-some-thoughts" class="nav-link" data-scroll-target="#some-thoughts"><span class="header-section-number">6.8</span> Some thoughts</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/pfmc-assessments/pfmc_assessment_handbook/edit/main/cloud-computing.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/pfmc-assessments/pfmc_assessment_handbook/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Cloud computing: jittering a stock assessment</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This is the path that I (Kiva) figured out and it worked for me. I am not an expert on computers, cloud computing, or computer security, so if you find yourself thinking “huh, why is she recommending that and not this,” there is probably not a very good reason! In other words, please let me know if you think this could be improved.</p>
<section id="pick-a-vm" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="pick-a-vm"><span class="header-section-number">6.1</span> Pick a VM</h2>
<ol type="1">
<li>You’ll need an NMFS Azure account. Contact <a href="mailto:christine.stawitz@noaa.gov">Christine Stawitz</a> to get one.</li>
<li>Log in.</li>
<li>Click on Virtual machines -&gt; Create. I think the preset configurations are helpful.</li>
<li>I’ve been using the D-series</li>
<li>Give it a name. Other settings I changed from defaults:
<ol type="1">
<li>Size. Decide how many CPUs (cores) you want. This sets how many stock assessments can be run concurrently.</li>
<li>Under networking, add HTTP (80) and HTTPS (443) to the inbound ports. Ignore the warning.</li>
</ol></li>
<li>Once you get to the end of all of the options, mostly sticking to defaults, click “Create.”</li>
<li>You’ll need to create a new SSH key for your VM. Once again, just click on the default buttons to keep things advancing, letting the many settings you don’t entirely understand wash over you. (You probably created an SSH key at some point for github.)</li>
</ol>
<p>You’re done! It will take a few moments to get going. If after trying it out you don’t like it, no worries! Most of these settings can be changed on the fly!</p>
<p>I started out with an 8 core VM. This was twice as many as my laptop, so the gains were not huge. For production purposes, I would probably opt for 16 cores.</p>
</section>
<section id="connect-to-your-vm" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="connect-to-your-vm"><span class="header-section-number">6.2</span> Connect to your VM</h2>
<p>There are several ways to do this. This is what I do:</p>
<p>Go to the Azure home portal. Under “Resources” your VM should be there. Click on it. If the “Start” button is blue, click on it. This is sort of like turning on your computer. Creating a new VM will automatically turn it on.</p>
<p>Click on “Connect.” I use the Native SSH. Copy your SSH key’s file name to step 3 of the Native SSH directions. It is probably something like <code>[VM name]_key.pem</code>. It will give you the SSH command to run; copy it.</p>
<p>Open up Powershell, Git Bash, or similar. Change the directory (using <code>cd</code>) to wherever you stored your SSH key. If your computer asks if you are sure you want to do this, you bet you are sure.</p>
</section>
<section id="install-software" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="install-software"><span class="header-section-number">6.3</span> Install software</h2>
<p>First, install some software you will need for cloud computing by running the following lines in the command line:</p>
<pre><code>sudo apt-get update
sudo apt-get upgrade
sudo apt-get install libxml2 libxml2-dev # igraph
sudo apt-get install libcairo2-dev # Graphics packages
sudo apt-get install libssl-dev libcurl4-openssl-dev #httr
sudo apt-get install apache2</code></pre>
<p>To make sure everything is working, in your browser window, navigate to your VM’s IP address, which you can find in the Azure portal of your browser. You should see…</p>
<p>Now install R:</p>
<pre><code>sudo add-apt-repository ppa:marutter/rrutter
sudo apt update
sudo apt-get install r-base</code></pre>
<p>Update: I realized this installs R 3.6.3. That is pretty old. I tried the instructions <a href="https://cloud.r-project.org/">here</a>, but got some errors.</p>
<p>Install Rstudio Server:</p>
<p>To download the latest version of Rstudio Server, follow the directions <a href="https://posit.co/download/rstudio-server/">here</a>. If you followed the earlier specifications to set up the VM, you should select the operating system “Debian / Ubuntu.” The Ubuntu version that is installed shows up when you first SSH into the VM. For me, it was 20. You’ve already installed R, so scroll down to step 3. It will direct you to run</p>
<pre><code>sudo apt-get install gdebi-core</code></pre>
<p>And then a couple more lines specific to the version.</p>
<p>Christine Stawitz says “If you don’t like RStudio as an IDE, there are other options like Code Server (cloud version of VSCode) or Jupyter notebooks.”</p>
</section>
<section id="connect-to-rstudio" class="level2" data-number="6.4">
<h2 data-number="6.4" class="anchored" data-anchor-id="connect-to-rstudio"><span class="header-section-number">6.4</span> Connect to Rstudio</h2>
<p>In the Azure portal where you can see the VM settings, in the left bar under “Networking” select “Network settings.” Add an inbound port rule. The destination port rule should be 8787 (the default for Rstudio). Keep everything else as a default. As a test, on your browser, navigate to [VM IP address]:8787. You should see an Rstudio login.</p>
<p>I’m not sure what the correct login is, so let’s change it. From your VM’s Azure portal in your browser, under “Help,” click on “Reset password.” Click the “reset password” bubble. Pick a username and password.</p>
<p>Now return to that Rstudio login on your browser. Refresh, and enter your username and password you just chose. It should look just like a normal Rstudio window!</p>
<p>Ian: I was actually following the directions <a href="https://techcommunity.microsoft.com/t5/educator-developer-blog/hosting-rserver-and-rstudio-on-azure/ba-p/744389">here</a>, and then they got really long and I had something working so I stopped. Christine, independently, said she stopped at the same spot. IT may not like accessing it from the public IP address, but she said she is going to do it this way until she gets in trouble.</p>
<section id="a-note-on-rstudio" class="level3" data-number="6.4.1">
<h3 data-number="6.4.1" class="anchored" data-anchor-id="a-note-on-rstudio"><span class="header-section-number">6.4.1</span> A note on Rstudio</h3>
<p>Rstudio cannot parallel process using a “multicore” strategy, only “multisession.” The makes no difference on your Windows laptop, because Windows also does not support multicore parallel processing. However, if you have set up a Linux VM, it is theoretically an option. I do not know if it is faster or how much.</p>
</section>
</section>
<section id="install-packages" class="level2" data-number="6.5">
<h2 data-number="6.5" class="anchored" data-anchor-id="install-packages"><span class="header-section-number">6.5</span> Install packages</h2>
<p>Things should be looking more familiar! From the Rstudio (or your favorite IDE) tab in your browser, run:</p>
<pre><code>install.packages('remotes')

remotes::install_github('r4ss/r4ss')

# Plus any others you want, e.g., nwfscDiag, here, tidyverse, etc.</code></pre>
</section>
<section id="move-files" class="level2" data-number="6.6">
<h2 data-number="6.6" class="anchored" data-anchor-id="move-files"><span class="header-section-number">6.6</span> Move files</h2>
<p>There are several ways to do this. I am giving you directions for one approach, using Azcopy. To install Azcopy on your VM, run:</p>
<pre><code>wget https://aka.ms/downloadazcopy-v10-linux
tar -xvf downloadazcopy-v10-linux
sudo cp ./azcopy_linux_amd64_*/azcopy /usr/bin/</code></pre>
<p>Now</p>
<ol type="1">
<li>In the Azure portal of your browser, create a storage account. Title it whatever you want, maybe your name or the name of the assessment. Default settings should be fine.</li>
<li>On the left column under “Data storage,” click on “Containers.” Make a new container. Pick a name. Again, default settings are fine.</li>
<li>Navigate to your new container and on the top bar click on “Upload.” Upload whatever files you want to transfer.</li>
<li>In the same container, click on “Shared access signature” under “Security + networking.” I gave it all 7 permissions. Give yourself a little flexibility on the start and expiry date/time. I usually just subtract one day from the start and add one day to the end. You can also enter your VM’s IP address if you want.</li>
<li>Click “Generate SAS token and URL” and copy the text for the Blob SAS URL.</li>
<li>Back in your VM terminal, run</li>
</ol>
<pre><code>sudo azcopy copy "[paste Blob SAS URL]" "." --recursive</code></pre>
<p>The general syntax is:</p>
<pre><code>sudo azcopy copy "[copy from]" "[copy to]" --recursive</code></pre>
<p>The recursive addition is necessary if multiple files are involved. The files should be downloaded into a new folder with the same name as your container!</p>
<ol start="7" type="1">
<li>By default, the directory you just created does not have sufficient file permissions to run stock synthesis. To change this type:</li>
</ol>
<pre><code>sudo chmod 777 [model_directory]</code></pre>
<p>If you were transferring a stock assessment model, try running stock synthesis (probably using <code>-nohess</code>) to make sure it is working. To ensure you have the right executable, you can run <code>r4ss::get_ss_exe()</code> from Rstudio (or whatever cloud IDE you are using), and it will automatically download the correct executable to your selected working directory.</p>
<section id="other-file-transfer-methods-that-you-might-consider" class="level3" data-number="6.6.1">
<h3 data-number="6.6.1" class="anchored" data-anchor-id="other-file-transfer-methods-that-you-might-consider"><span class="header-section-number">6.6.1</span> Other file transfer methods that you might consider</h3>
<p>You could install git and clone your repo. I did not look into that because repos can get large and take a while to clone. You can easily download model files straight from github without git using <code>wget</code>, but will eventually need to write the results somewhere.</p>
<p>Another approach is to use the <code>scp</code> command from your local computer and avoid the blob storage and azcopy. I think you would have to open up the appropriate port on your VM. Hem, who uses Azure to run Atlantis, recommended the azcopy approach, so that is what I tried. I have used scp in the past on university computing clusters, and it may be fewer steps for each file transfer. I have no idea whether we can run scp on our federal laptops.</p>
</section>
</section>
<section id="make-sure-you-log-off-your-vm" class="level2" data-number="6.7">
<h2 data-number="6.7" class="anchored" data-anchor-id="make-sure-you-log-off-your-vm"><span class="header-section-number">6.7</span> Make sure you log off your VM!!!</h2>
<p>Hit “Stop” on the main Azure panel for your VM in your browser. This is akin to shutting down your computer. In general, cloud computing is paid by the minute. The per minute cost is low, but you don’t want to keep it on, e.g., overnight, if you are not using it.</p>
</section>
<section id="some-thoughts" class="level2" data-number="6.8">
<h2 data-number="6.8" class="anchored" data-anchor-id="some-thoughts"><span class="header-section-number">6.8</span> Some thoughts</h2>
<p>The strongest use case for this in production stock assessments is running jitters. The first time, this requires more active time on your part than running a jitter on your local computer. However, you should get the jitter results faster once it starts running. I ran 8 jitters all at once and it took X min of processing time! Once you set up your VM, you can get back on it whenever you want and your files and settings will be retained, so it is just a matter of transferring files and hitting run.</p>
<p>Note that {r4ss} is newly set up so that you can run jitters and retrospectives in parallel on your laptop, too! Your laptop just has fewer cores, so you can run fewer models at once. Profiles are not currently set up to run in parallel because it is often useful for convergence purposes to run them sequentially and then use the previous par file as the starter.</p>
<p>The VM will not run a single stock synthesis model any faster than your laptop. The gains are really in the number of models that you can run simultaneously.</p>
<p>Another use case for this is if you want to rerun all of your sensitivities on a new (e.g., post-STAR) base model. You could do something like <code>furrr::future_walk(dir_string, r4ss::run)</code>. For research (e.g., simulations, variable selection, cross validation), the use cases are endless!</p>
<p>I can fumble my way through file management from the command line, but I don’t love it. Normally we all probably think of Rstudio as an environment for writing and executing R code, but it does provide a nice graphical file manager that I have been making use of. You can also open and edit any text file, including all of the inputs and outputs for stock synthesis. (Other IDEs should provide this functionality, too.) Your Ubuntu VM does come with Vim.</p>
<p>Until June, 2024, my understanding is this is all free. After that, we may need to pay. Christine Stawitz thinks it will be possible to pay for the credits in advance when funds are available, and use the credits whenever we want. (Cloud computing in general definitely works that way. It is possible the federal bureacracy ruins it, like all nice things.)</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./05-other.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Other useful tidbits</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./appendix-a.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Species seen* in the hake fishery</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>